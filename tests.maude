load timedFarm .

omod BASE is
  protecting TIMED-FARM .

  ops robotAttrs workerAttrs transporterAttrs : -> AttributeSet .
  op fieldAttrs : -> AttributeSet .
  ops rob rob2 : -> Object .
  ops I1 I2 I3 I4 I5 I6 I7 : -> Object .
  op resupply : -> Object .
  op collection : -> Object .
  ops GL1 GL2 : -> Object .
  ops intersections1 : -> Configuration .
  op farm1 : -> Configuration .
  op map1 : -> Object .
  op base1 : -> ClockedConfiguration .

  eq robotAttrs = transRange : 1000, maxSpeed : 1, detected : empty, auctions : empty, activeTasks : empty,
    handledTime : false, workState : noWork, obsCoords : nil, negotiations : empty, yieldStatus : noYieldInfo, waitingStatus : noWaitingInfo .
  eq transporterAttrs = cargoLevel : emptyCargo .
  eq workerAttrs = cargoLevel : full .
  eq fieldAttrs = handledTime : false, transRange : 200, growingState : growing, waterLevel : good, fertilizerLevel : good, waterTimer : [cur: 500 - base: 500],
    fertilizerTimer : [cur: 1000 - base: 1000], growTimer : [cur: 2000 - base: 2000], reserved : false, auctions : empty, activeTasks : empty .

  eq I1 = < "I1" : PassIntersection | coordinate : (0,0), neighbors : ("I2" , "I3" , "GL1") > .
  eq I2 = < "I2" : PassIntersection | coordinate : (100,0), neighbors : ("I1" , "I4" , "I5" , "I6") > .
  eq I3 = < "I3" : PassIntersection | coordinate : (0,-100), neighbors : ("I4" , "I1" , "Resupply") > .
  eq I4 = < "I4" : PassIntersection | coordinate : (100,-100), neighbors : ("I2" , "I3" , "Collection" , "GL2") > .
  eq I5 = < "I5" : PassIntersection | coordinate : (200, 0), neighbors : "I2" > .
  eq I6 = < "I6" : PassIntersection | coordinate : (100,100), neighbors : "I2" > .

  eq resupply = < "Resupply" : ResupplySite | coordinate : (-50, -100), neighbors : "I3" > .
  eq collection = < "Collection" : CollectionSite | coordinate : (100,-150), neighbors : "I4", collections : 0 > .
  eq intersections1 = I1 I2 I3 I4 I5 I6 resupply collection GL1 GL2 .

  eq GL1 = < "GL1" : Field | coordinate : (0, 100), neighbors : "I1", growingArea : area(((-1, 100), (1,100), (-1, 101), (1, 101))), fieldAttrs > .
  eq GL2 = < "GL2" : Field | coordinate : (150, -100), neighbors : "I4", growingArea : area(((150,-101), (150, -99), (151,-101), (151, -99))), fieldAttrs > .
  
  eq rob = < "W1" : Worker | curCargo : water, detectionRange : 10, speed : 1, coordinate : (30, 0), state : idle, direction : west, remainingPath : nil, curTask : noTask, robotAttrs, workerAttrs > .
  eq rob2 = < "T1" : Transporter | curCargo : produce, speed : 0, detectionRange : 5, coordinate : (0,-1), state : idle, direction : east, remainingPath : nil, curTask : noTask,  robotAttrs, transporterAttrs > .

  eq map1 = < "Map" : Map | intersections : intersections1, roads : createRoadSet(intersections1) > .
  
  eq farm1 = map1 collection resupply .
  eq base1 = farm1 rob @ 0 .
endom

omod TESTS is
  protecting BASE .

  op testFieldAttrs : -> AttributeSet .
  ops testGL testGL2 : -> Object .

 eq fieldAttrs = handledTime : false, transRange : 1000, growingState : growing, waterLevel : good, fertilizerLevel : good, 
    waterTimer : [cur: 500 - base: 5000],
    fertilizerTimer : [cur: 700 - base: 7000], 
    growTimer : [cur: 900 - base: 900], reserved : false, auctions : empty, activeTasks : empty .

  eq testGL = < "GL1" : Field | coordinate : (0, 100), neighbors : "I1", growingArea : area(((-1, 100), (1,100), (-1, 101), (1, 101))), fieldAttrs > .
  eq testGL2 = < "GL2" : Field | coordinate : (150, -100), neighbors : "I4", growingArea : area(((150,-101), (150, -99), (151,-101), (151, -99))), fieldAttrs > .
  op test1 : -> ClockedConfiguration .
  eq test1 = farm1 testGL testGL2 rob rob2 @ 0 .
endom

--- search [1] test1 [LIMIT: 700] =>* C:Configuration < "Collection" : CollectionSite
---  | collections : 1 > @ T:Time [LIMIT: 700] .
rew test1 [LIMIT: 7000] .